<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>!</title><link rel="stylesheet" href="../node_modules/reveal.js/css/reset.css"><link rel="stylesheet" href="../node_modules/reveal.js/css/reveal.css"><link rel="stylesheet" href="../node_modules/reveal.js/css/theme/black.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "../node_modules/reveal.js/css/print/pdf.css" : "../node_modules/reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><link rel="stylesheet" href="../src/stylesheets/cloudouest.css"></head><body><div class="reveal"><div class="slides"><section class="title entrypoint" data-state="title"><h1>!</h1></section><section><section id="_les_présentations"><h2>Les présentations</h2></section><section><div class="slide-content"><div class="imageblock"><img src="../../src/images/yann.png" alt="yann"></div>
<aside class="notes"><div class="ulist"><ul><li><p>Tech lead Onepoint depuis 3 ans</p></li><li><p>11 ans de carrière dans le web d&#8217;abord puis dans le devops</p></li><li><p>Industrialisation : la flemme de faire toujours la même chose</p></li><li><p>Découverte de docker pour les env de dev (Vagrant sur windows, c&#8217;était pas ouf)</p></li><li><p>Puis docker en prod</p></li></ul></div></aside></div></section><section><div class="slide-content"><div class="imageblock"><img src="../../src/images/docker.png" alt="docker"></div>
<aside class="notes"><div class="ulist"><ul><li><p>Notre sujet du jours</p></li><li><p>"Docker est une plateforme ouverte pour le développement, le déploiement et l’exécution d’applications. Il permet d’embarquer et d’exécuter une application dans un environnement cloisonné appelé conteneur."</p></li><li><p>Solution de containerisation qui a "un peu" révolutionner notre métier</p></li><li><p>Je ne vais pas épiloguer sur le sujet, je pense que vous connaissez</p></li><li><p>Si ce n&#8217;est pas le cas, vous risquez d&#8217;être un peu perdu</p></li></ul></div></aside></div></section><section id="_les_trucs_à_savoir"><h2>Les trucs à savoir</h2><div class="slide-content"><div class="paragraph"><p>Avant de commencer</p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Ici, on va parler de docker-compose ancienne version</p></li><li><p>Mais les principes restent les mêmes</p></li><li><p>La plupart des règles sont applicables aussi avec les orchestrateurs</p></li></ul></div></aside></div></section><section id="_pour_un_public_averti"><h2>Pour un public averti</h2><div class="slide-content"><div class="ulist"><ul><li><p>Connaissance avancée de docker</p></li><li><p>Savoir comment un réseau fonctionne</p></li><li><p>Quelques bases en sécurité informatique</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Ce que je n&#8217;aborderais pas :</p></div>
<div class="ulist"><ul><li><p>Le fonctionnement de docker</p></li><li><p>Le fonctionnement d&#8217;un réseau</p></li><li><p>Les bases de la sécurité informatique.</p></li><li><p>Pourquoi il faut sécuriser ses applications, infra, etc.</p></li><li><p>Les risques et impacts pour les différentes failles et éléments de configuration (ce serait trop long).</p></li><li><p>Le sens profond de l&#8217;acronyme DICT (Disponibilité, Intégrité, Confidentialité, Traçabilité)</p></li></ul></div></aside></div></section><section id="_cest_parti"><h2>C&#8217;est parti !</h2></section></section>
<section><section id="_il_était_une_forge_logiciel" data-transition="fade"><h2>Il était une forge logiciel</h2><div class="slide-content"><div class="imageblock"><img src="../../src/images/infra.png" alt="infra"></div><aside class="notes"><div class="ulist"><ul><li><p>Infra de forge (à peu près)</p></li><li><p>Assez classique</p></li><li><p>Avec zone privée, publique et outils de monitoring et gestion de secret commune</p></li><li><p>Avec surement des choses à revoir, mais ce n&#8217;est pas le sujet</p></li><li><p>Expliquer un peu le schéma</p></li></ul></div></aside></div></section><section id="_avec_des_vms" data-transition="fade"><h2>avec des vms</h2><div class="slide-content"><div class="imageblock"><img src="../../src/images/infra-vm.png" alt="infra vm"></div>
<aside class="notes"><div class="ulist"><ul><li><p>Notre stratégie de déploiement</p></li><li><p>1 VM et 1 docker-compose par appli</p></li><li><p>Ce n&#8217;est pas l&#8217;idéal, surement pas à l&#8217;état de l&#8217;art</p></li><li><p>Mais on a réussi à mettre du docker en place et c&#8217;est déjà pas mal</p></li></ul></div></aside></div></section><section id="_docker_partout" data-transition="fade"><h2>Docker partout</h2><div class="slide-content"><div class="imageblock"><img src="../../src/images/infra-docker.png" alt="infra docker"></div>
<aside class="notes"><div class="paragraph"><p>Donc :</p></div>
<div class="ulist"><ul><li><p>Tous nos outils tournent sous docker</p></li><li><p>C&#8217;est un Element central de notre infra</p></li><li><p>Omniprésent (voir omnipotent)</p></li></ul></div></aside></div></section><section id="_et_avec_les_droits_root"><h2>Et avec les droits root</h2><div class="slide-content"><div class="paragraph"><p><span class="image"><img src="../../src/images/suspicious.gif" alt="suspicious"></span></p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Et avec les droits root</p></li><li><p>Donc il a accès à à peu près tout</p></li><li><p>Y&#8217;a de quoi se poser des questions !</p></li></ul></div></aside></div></section><section id="_la_confiance_nexclut_pas_le_contrôle"><h2>"La confiance n&#8217;exclut pas le contrôle"</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>On connait docker, en tout cas, on pense savoir comment fonctionne docker</p></li><li><p>Docker est utilisé un peu partout</p><div class="ulist"><ul><li><p>Dans notre infra, mais aussi dans le monde de l&#8217;IT</p></li><li><p>Donc niveau de confiance au top</p></li></ul></div></li><li><p>Comment être sur que cette couche logiciel est sécurisée/bien configurée ?</p></li><li><p>On connait tous, plus ou moins, de bonnes pratiques</p></li><li><p>mais on voulait aller un peu plus loin</p></li></ul></div></aside></div></section><section><div class="slide-content"><div class="paragraph"><p><span class="image"><img src="../../src/images/doc-anssi.png" alt="doc anssi" width="40%"></span></p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Après quelques recherches</p></li><li><p>On a trouvé ça</p></li><li><p>Le guide de l&#8217;ANSSI</p></li><li><p>On va se rendre compte que la conf' de base n&#8217;est pas hyper sécure</p></li><li><p><a href="https://www.ssi.gouv.fr/guide/recommandations-de-securite-relatives-au-deploiement-de-conteneurs-docker/" class="bare">https://www.ssi.gouv.fr/guide/recommandations-de-securite-relatives-au-deploiement-de-conteneurs-docker/</a></p></li></ul></div></aside></div></section><section id="_parcourons_le_ensemble"><h2>Parcourons-le ensemble</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>On va revoir les différentes règles, mais pas dans l&#8217;ordre</p></li><li><p>Réorganiser par catégories/difficultés</p></li><li><p>On va parler de</p><div class="ulist"><ul><li><p>Limitation des ressources</p></li><li><p>De permissions et de filesystem</p></li><li><p>Passage rapide par les logs</p></li><li><p>De réseau</p></li><li><p>De truc étrange et effrayant à la fin</p></li></ul></div></li><li><p>Des plus simples/évidentes, au plus complexe/inapplicable</p></li></ul></div></aside></div></section></section>
<section><section id="_limitons_notre_consommation"><h2>Limitons notre consommation</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>Pour éviter que les containers consomment toutes les ressources disponibles</p></li><li><p>Et mettent notre système à l&#8217;arrêt ou en mode dégradé.</p></li><li><p>Problème de disponibilités</p></li></ul></div></aside></div></section><section id="_r10" class="background-easy"><h2>R10</h2><div class="slide-content"><h3>Limiter l&#8217;utilisation de la mémoire de l&#8217;hôte pour chaque conteneur</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run \
  --memory=128m \
  --memory-swap=64m busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    mem_limit: 128m
    memswap_limit: 64m</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>On commence en douceur</p></li><li><p>"Chaque conteneur doit être démarré avec une limite maximale d’utilisation de la mémoire de l’hôte, avec l’option --memory, et une limite maximale d’utilisation de la mémoire SWAP de l’hôte avec l’option --memory-swap."</p></li></ul></div>
<div class="paragraph"><p>Par défaut, un conteneur n’a pas de contraintes de ressources et peut utiliser toutes les ressources disponibles sur l’hôte</p></div></aside></div></section><section id="_r11" class="background-easy"><h2>R11</h2><div class="slide-content"><h3>Limiter l&#8217;utilisation du CPU de l&#8217;hôte pour chaque conteneur</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --cpus=2 busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    mem_limit: 128m
    memswap_limit: 64m
    cpu_percent: 80
    cpus: 2</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>Comme pour la mémoire</p></li><li><p>"Chaque conteneur doit être démarré avec une limite maximale d’utilisation du CPU de l’hôte avec l’option --cpus, ou avec les options --cpu-period et --cpu-quota."</p></li></ul></div>
<div class="paragraph"><p>cpu_count, cpu_percent, cpu_shares, cpu_period, cpu_quota, cpus, cpuset</p></div></aside></div></section><section id="_r9" class="background-easy"><h2>R9</h2><div class="slide-content"><h3>Dédier les Control groups pour chaque conteneur</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    #cgroup_parent: forbid</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>On commence avec les gros mots : Les control groups</p></li><li><p>"Chaque conteneur doit être démarré avec des Control Groups distincts de l’hôte et donc sans l’option --cgroup-parent."</p></li><li><p>Les cgroups : fonctionnalité du noyau Linux pour limiter, compter et isoler l&#8217;utilisation des ressources (processeur, mémoire, utilisation disque, etc.). Les groupes de controle permettent de créer des restrictions.</p></li><li><p>Par défaut Docker crée des control group pour chaque container, laissez comme ça.</p></li></ul></div></aside></div></section><section id="_objectifs"><h2>Objectifs</h2><div class="slide-content"><div class="ulist"><ul><li><p>Eviter la surcharge du système</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Via :</p></div>
<div class="ulist"><ul><li><p>Limitation mémoire</p></li><li><p>Limitation CPU</p></li></ul></div>
<div class="paragraph"><p>Le petit plus, ça peut aider en écoconception aussi</p></div></aside></div></section><section id="_bon_à_savoir"><h2>Bon à savoir</h2><div class="slide-content"><div class="ulist"><ul><li><p>Ce sont des configurations limitatives, non reservatives</p></li><li><p>Docker-compose : attention à la version 3, utilisez la version 2</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Ce sont des configurations limitatives, non reservatives :</p></div>
<div class="ulist"><ul><li><p>Vous pouvez donc dépasser les ressources de votre hôte que ce soit avec un ou plusieurs containers.</p></li><li><p>Attention à ce que tous les containers ne tournent pas à "fond" tous en même temps.</p></li><li><p>Même principe que l&#8217;Overprovisionning</p></li></ul></div>
<div class="paragraph"><p>Docker-compose : attention à la version 3, utilisez la version 2 :</p></div>
<div class="ulist"><ul><li><p>Bien que cela soit étrange</p></li><li><p>La version 3 de docker-compose n&#8217;est pas l&#8217;évolution de la version 2</p></li><li><p>Mais la version faite pour docker-swarm.</p></li><li><p>Vous ne pourrez pas configurer les restrictions de ressources "docker" avec la version 3 de docker-compose en mode standalone.</p></li><li><p>Restez sur la version 2 en mode standalone</p></li></ul></div></aside></div></section></section>
<section><section id="_les_accès_fs_et_permissions"><h2>Les accès FS et permissions</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>Le grand classique
Dans la majorité des cas, les containers ont les droits d&#8217;écrire du disque :</p></li><li><p>que ce soit via des volumes</p></li><li><p>directement dans le container (ce qui reste une écriture disque)</p></li><li><p>Il existe quelques stratégies permettant de limiter/supprimer ces accès disques.</p></li></ul></div></aside></div></section><section id="_r1" class="background-easy"><h2>R1</h2><div class="slide-content"><h3>Isoler les systèmes sensibles de ﬁchiers de l&#8217;hôte</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    privileged: false # default value
  volumes:
    - '/:/' # Non mais franchement !</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Chaque conteneur doit être démarré sans partager les systèmes de ﬁchiers sensibles de l’hôte : le système de ﬁchiers racine (/ ), des périphériques (/dev), des processus. (/proc) ou virtuel (/sys). Par conséquent, l’option --privileged ne doit pas être utilisée."</p></li><li><p>On le fait naturellement, sauf pour le privileged, qu&#8217;on a tendance mettre au besoin</p></li><li><p>Les amateurs de docker in docker savent de quoi je parle</p></li><li><p>Pour rappel, l&#8217;option privileged donne toutes les capabilities au container, dont un accès complet à tous les devices (au sens linux) de l&#8217;host</p></li></ul></div></aside></div></section><section id="_r2" class="background-medium"><h2>R2</h2><div class="slide-content"><h3>Restreindre l&#8217;accès aux périphériques de l&#8217;hôte</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run \
  --device=/dev/usb:/dev/usb busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    devices:
    - "/dev/usb:/dev/usb"</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Si un conteneur doit être démarré avec un périphérique de l’hôte, celui-ci doit être ajouté au conteneur avec l’option --device et les options complémentaires rwm spécifiées pour en limiter l’accès au strict minimum nécessaire."</p></li><li><p>Si vous avez quand même besoin d&#8217;acceder directement à un des périphériques de l&#8217;host, ou des accès privilégies sur un device, utilisé cette option plutôt que privileged.</p></li><li><p>Honnêtement, je n&#8217;ai jamais eu à l&#8217;utiliser et je n&#8217;y aurai jamais pensé.</p></li><li><p>Mais ne connectez pas votre casque usb à vos containers !</p></li></ul></div></aside></div></section><section id="_r12" class="background-hard"><h2>R12</h2><div class="slide-content"><h3>Restreindre en lecture le système de ﬁchiers racine de chaque conteneur</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --read-only busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    read_only: true</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>On commence à rentrer dans le dur</p></li><li><p>"Chaque conteneur doit être démarré avec son système de fichiers racine, ou root filesystem, en lecture seule avec l’option --read-only."</p></li><li><p>attention, c&#8217;est difficile à appliquer surtout lorsque qu&#8217;il y a des fichiers de cache ou des images que nous n&#8217;avons pas créer, donc que nous ne connaissons pas bien</p></li></ul></div></aside></div></section><section id="_r12_2" class="background-medium"><h2>R12-</h2><div class="slide-content"><h3>Limiter l&#8217;écriture de l&#8217;espace de stockage de chaque conteneur</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run \
  --storage-opt size=10G busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    storage_opt:
      size: '10G'</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>Si ce n&#8217;est pas possible</p></li><li><p>"Un conteneur peut être démarré avec une limite maximale d’utilisation de l’espace disque de l’hôte pour son système de ﬁchiers racine, ou root ﬁlesystem, en lecture et écriture avec l’option --storage-opt."</p></li></ul></div></aside></div></section><section id="_r12_3" class="background-medium"><h2>R12--</h2><div class="slide-content"><h3>Limiter l&#8217;écriture de l&#8217;espace de stockage de l&#8217;ensemble des conteneurs</h3><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">sudo mount /dev/sdc2 /var/lib/docker/</code></pre></div></div>
<aside class="notes"><div class="ulist"><ul><li><p>Si vraiment, c&#8217;est trop compliqué de limiter les permissions</p></li><li><p>"Un conteneur peut être démarré avec son système de fichiers racine, ou root ﬁlesystem en lecture et écriture, dès lors que la zone de stockage local de Docker, par défaut /var/lib/docker/ sur Linux, est une partition dédiée et distincte des partitions de l’hôte. Dans ce cas, la menace d’un déni de service d’un conteneur vis-à-vis d’un autre conteneur est à considérer."</p></li><li><p>Monter le répertoire de docker dans une partition à part entière</p></li></ul></div></aside></div></section><section id="_r13" class="background-easy"><h2>R13</h2><div class="slide-content"><h3>Créer un système de stockage pour les données non persistantes</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run \
--mount type=tmpfs,destination=/cache \
busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    tmpfs:
      - /cache</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Les répertoires contenant des données non persistantes ou temporaires doivent être montés à l’aide d’un montage bind tmpfs avec l’option --mount type=tmpfs et les options de tmpfs, tmpfs-size et tmpfs-mode"</p></li><li><p>idéal pour les repertoires de cache, et en plus ça améliorera les perfs de l&#8217;application</p></li></ul></div></aside></div></section><section id="_r14" class="background-medium"><h2>R14</h2><div class="slide-content"><h3>Créer un système de stockage pour les données persistantes ou partagées</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash"># bind mount
docker run –v /data/myapp/data:/data \
  busybox
# volume
docker volume create myvol
docker run –v myvol:/data busybox
# volume ro
docker run –v myvol:/data:ro busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    volumes:
      - /data/myapp/data:/data/:ro</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Les répertoires contenant des données persistantes ou partagées avec l’hôte, ou avec d’autres conteneurs, doivent être montés à l’aide de :</p></li><li><p>un montage bind mount, avec une limitation de l’espace disque utilisable (option --mount type=bind,o=size), ou</p></li><li><p>un montage bind volume d’une partition dédiée et distincte des partitions utilisées par l’hôte, ou d’un volume Docker, avec une limitation spéciﬁée de l’espace disque (option --mount type=volume).
Si les données persistantes ou partagées ne doivent pas être modiﬁées par le conteneur, les répertoires doivent être montés en lecture seule avec l’option read-only."</p></li><li><p>soit vous utilisez les volumes mais en limitant la taille et les droits d&#8217;accès au strict nécessaire, pour se proteger ET de la surcharge ET des écritures non souhaitées</p></li></ul></div></aside></div></section><section id="_r15" class="background-easy"><h2>R15</h2><div class="slide-content"><h3>Restreindre l&#8217;accès aux répertoires et aux ﬁchiers sensibles</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Si un conteneur doit partager des répertoires ou des fichiers sensibles avec l’hôte ou un autre conteneur, il doit être démarré en restreignant ses accès au strict minimum nécessaire."</p></li><li><p>c&#8217;est assez naturel, mais ça fait du bien de le rappeler</p></li></ul></div></aside></div></section><section id="_objectifs_2"><h2>Objectifs</h2><div class="slide-content"><div class="ulist"><ul><li><p>Eviter les modifications/suppressions malheureuses sur le disque</p></li><li><p>Volontaires ou non.</p></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>On cherche à limiter au maximum les accès au fs hote</p><div class="ulist"><ul><li><p>Isolation interne</p></li><li><p>Isolation externe</p></li></ul></div></li><li><p>Effet de bord positif : vu qu&#8217;on va écrire en RAM, meilleurs perf'</p></li></ul></div></aside></div></section></section>
<section><section id="_les_logs"><h2>Les logs</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>Les logs :</p></li><li><p>Si on limite les accès disques</p></li><li><p>qu&#8217;on souhaite éviter que TOUS les logs sortent sur la sortie standard</p></li><li><p>comment faire pour les gérer correctement ?</p></li><li><p>Deux petites règles à ce sujet</p></li></ul></div></aside></div></section><section id="_r16" class="background-easy"><h2>R16</h2><div class="slide-content"><h3>Exporter les journaux avec Docker</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run \
  --logdriver=syslog busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    logging:
      driver: syslog
      options:
        syslog-address: "tcp://ip:123"</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Le service Docker doit être conﬁguré pour collecter les journaux d’évènements issus de l’application « conteneurisée » et les exporter vers un serveur centralisé avec l’option --log-driver=&lt;logging driver&gt; (en ligne de commande ou dans le ﬁchier de conﬁguration)."</p></li><li><p>Aller voir dans la doc, ça va de l&#8217;écriture fichier, à l&#8217;envoie automatique vers splunk en passant par gelf</p></li></ul></div></aside></div></section><section id="_r16_les_logs_drivers"><h2>R16 : Les logs drivers</h2><div class="slide-content"><div class="paragraph"><p><span class="image"><img src="../../src/images/logdrivers.png" alt="logdrivers"></span></p></div>
<aside class="notes"><div class="ulist"><ul><li><p>issue de la doc docker</p></li><li><p>il y a du choix</p></li><li><p>le mieux étant l&#8217;envoie direct vers un service de collecte</p></li></ul></div></aside></div></section><section id="_r16_2" class="background-medium"><h2>R16-</h2><div class="slide-content"><h3>Exporter les journaux depuis l&#8217;intérieur du conteneur</h3><aside class="notes"><div class="ulist"><ul><li><p>"L&#8217;export des journaux d’évènements issus de l&#8217;application « conteneurisée » peut être mise en œuvre à l’intérieur du conteneur par une solution distincte de Docker."</p></li><li><p>On va laisser l&#8217;application gérer l&#8217;envoie des logs vers l&#8217;extérieur</p></li></ul></div></aside></div></section><section id="_objectifs_3"><h2>Objectifs</h2><div class="slide-content"><div class="ulist"><ul><li><p>Dehors les logs !</p></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>On ne garde pas les logs sur la machine</p></li><li><p>De manière générale, les logs doivent être centralisés sur une autre machine. Que ce soit pour des applications containerisées ou non.</p></li></ul></div></aside></div></section></section>
<section><section id="_parlons_réseau"><h2>Parlons réseau</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>Pas fun fact : "Par défault, le deamon docker met tous les containers sur le même réseau."</p></li><li><p>Donc, par défault, tous les containers peuvent communiquer entre eux.</p></li><li><p>Euh : Il n&#8217;y aurait pas un problème là ?</p></li></ul></div></aside></div></section><section id="_r3" class="background-medium"><h2>R3</h2><div class="slide-content"><h3>Interdire la connexion du conteneur au réseau bridge docker0</h3><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">#/ etc/systemd/system/docker.service.d/override.conf
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd:// \
  --containerd=/run/containerd/containerd.sock --bridge=none</code></pre></div></div>
<aside class="notes"><div class="ulist"><ul><li><p>"Le service Docker doit être configuré pour démarrer un conteneur sans le connecter, par défaut, au réseau bridge, docker0, avec l’option --bridge=none (en ligne de commande ou dans le fichier de conﬁguration)."</p></li><li><p>Le truc caché auquel on ne s&#8217;attend pas</p></li><li><p>Attention, par défaut TOUS vos containers peuvent communiquer les uns avec les autres, donc si un container est vérolé, il pourra potentiellement infecter les autres.</p></li><li><p>Sauf avec docker-compose qui crée un réseau spécifique par "groupe de container"</p></li></ul></div></aside></div></section><section id="_r4" class="background-easy"><h2>R4</h2><div class="slide-content"><h3>Isoler l&#8217;interface réseau de l&#8217;hôte</h3><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --network=host busybox # INTERDIT !</code></pre></div></div>
<aside class="notes"><div class="ulist"><ul><li><p>"Chaque conteneur doit être démarré sans partager l’interface réseau de l’hôte. L’option --network host ne doit pas être utilisée."</p></li><li><p>Garder vos containers sur le réseau docker, ne les laisser pas acceder au réseau de votre machine. On ne sait pas ce qu&#8217;il peut se passer.</p></li></ul></div></aside></div></section><section id="_r5" class="background-medium"><h2>R5</h2><div class="slide-content"><h3>Créer un réseau dédié pour chaque connexion</h3><div class="paragraph"><p><span class="image"><img src="../../src/images/networks.png" alt="networks"></span></p></div>
<aside class="notes"><div class="ulist"><ul><li><p>"Si le conteneur doit « exposer » un port de l’interface réseau de l’hôte ou doit être connecté à un ou plusieurs autres conteneurs, un réseau dédié doit être créé pour chaque connexion."</p></li><li><p>Exemple, avec frontal, db et back &#8658; un réseau par connexion</p></li><li><p>Bon à savoir : Docker-compose crée par défaut des réseaux dédiés par groupe de container, donc pas de configuration supplémentaire à faire dans ce cas.</p></li></ul></div></aside></div></section><section id="_r5_exemple"><h2>R5 : Exemple</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">services:
  artifactory:
    image: jfrog/artifactory-pro
    networks:
      - artifactory_internal
  nginx:
    image: nginx
    networks:
      artifactory_internal: ~
      artifactory_front: ~
networks:
  artifactory_front: ~
  artifactory_internal:
    internal: true # no access to host network/internet</code></pre></div></div>
<aside class="notes"><div class="ulist"><ul><li><p>Exemple avec un artifactory derrière un nginx</p></li><li><p>Un réseau entre nginx et artifactory</p></li><li><p>Un réseau entre nginx et l&#8217;exterieur</p></li><li><p>nginx est dans les deux et artifactory seulement dans le réseau interne</p></li></ul></div></aside></div></section><section id="_objectifs_4"><h2>Objectifs</h2><div class="slide-content"><div class="ulist"><ul><li><p>Isolation</p></li><li><p>White lister les connexions</p></li></ul></div></div></section></section>
<section><section id="_les_limitations_kernel_et_autres_joyeusetés"><h2>Les limitations Kernel et autres joyeusetés</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>Le boss mode</p></li><li><p>Capabilities Kernel, namespace PID, IPC, etc., autant d&#8217;éléments de configuration permettant de vraiment isoler docker du reste du système.</p></li></ul></div></aside></div></section><section id="_révisions"><h2>Révisions</h2><div class="slide-content"><h3>Les namespaces système</h3><div class="ulist"><ul><li><p>Fonctionnalité du noyau linux :</p><div class="ulist"><ul><li><p>Partitionnement des ressources</p></li><li><p>Limitation des accès au namespace du groupe de process d&#8217;un même namespace</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>Les espaces de noms sont une fonctionnalité du noyau Linux qui partitionne les ressources du noyau de telle sorte qu&#8217;un ensemble de processus voit un ensemble de ressources tandis qu&#8217;un autre ensemble de processus voit un ensemble différent de ressources.</p></li></ul></div></aside></div></section><section id="_révisions_2"><h2>Révisions</h2><div class="slide-content"><h3>Les namespaces dédiées à chaque container</h3><div class="ulist"><ul><li><p>MNT : point de montage du FS</p></li><li><p>PID : id des process</p></li><li><p>NET : interface réseau</p></li><li><p>IPC : canaux de communcation inter-prcess</p></li><li><p>UTS : hostname, résolution de nom de domaine NIS</p></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>Quelques namespaces sont spécifiques à chaque container</p></li></ul></div></aside></div></section><section id="_révisions_3"><h2>Révisions</h2><div class="slide-content"><h3>Les namespaces partagés avec l&#8217;hôte</h3><div class="ulist"><ul><li><p>USER ID : partage des id user</p></li><li><p>CGROUP : règles d&#8217;accès aux ressources</p></li><li><p>Time : partage de l&#8217;heure avec l&#8217;hôte</p></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>D&#8217;autre sont partagé avec l&#8217;host</p></li><li><p>Le plus classique les id user, on s&#8217;est tous rendu compte des bizzareries quand on fait des montages sur le disque</p></li><li><p>Le namespage des CGroup, comme on en a parlé un peu avant</p></li></ul></div></aside></div></section><section id="_r6" class="background-easy"><h2>R6</h2><div class="slide-content"><h3>Dédier des namespaces PID, IPC et UTS pour chaque conteneur</h3><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --pid= --uts= ... busybox # INTERDIT !</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>"Chaque conteneur doit être démarré avec les namespaces PID, IPC et UTS distincts de l’hôte et des autres conteneurs et donc sans les options --pid, --ipc et --uts."</p></div>
<div class="ulist"><ul><li><p>Il est déconseillé d&#8217;essayer d&#8217;utiliser les namespace host dans les containers.</p></li><li><p>Typiquement, on pourrait kill des process host à partir d&#8217;un container</p></li><li><p>Ou faire communiquer des process interne au container avec d&#8217;autres process de l&#8217;hote</p></li><li><p>Et vous ne voulez pas ça !</p></li></ul></div></aside></div></section><section id="_r7" class="background-hard"><h2>R7</h2><div class="slide-content"><h3>Dédier un namespace USER ID pour chaque conteneur</h3><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">#/ etc/systemd/system/docker.service.d/override.conf
ExecStart=/usr/bin/dockerd ... --userns-remap="secureuser:secureuser"</code></pre></div></div>
<aside class="notes"><div class="ulist"><ul><li><p>"Le service Docker doit être conﬁguré pour démarrer tous les conteneurs avec un namespace USER ID distinct de l’hôte et des autres conteneurs avec l’option --userns-remap (en ligne de commande ou dans le ﬁchier de conﬁguration). Cette conﬁguration doit s’accompagner d’une interdiction de créer de nouveau namespace USER ID à l’intérieur du conteneur."</p></li><li><p>ATTENTION avec les bind mounts et les permissions</p></li><li><p>les id de l&#8217;utilisateur dans le container ne seront plus les mêmes que sur l&#8217;host</p></li><li><p>"on map ses ids sur un autre".</p></li></ul></div></aside></div></section><section id="_r7_2" class="background-hard"><h2>R7+</h2><div class="slide-content"><h3>Restreindre la création des Namespace USER ID à l&#8217;utilisateur root</h3><aside class="notes"><div class="ulist"><ul><li><p>"Sur les systèmes Linux à base Debian, la conﬁguration système kernel.unprivileged_userns_clone doit être égale à 0 (valeur par défaut) pour restreindre la création d’un Namespace USER ID au seul utilisateur root (UID=0)."</p></li><li><p>On touche pas non plus, sinon vous allez permettre aux utilisateurs non root de créer des espace de nom. Et vous ne le voulez, c&#8217;est sur !</p></li></ul></div></aside></div></section><section id="_r7_3" class="background-medium"><h2>R7-</h2><div class="slide-content"><h3>Restreindre le partage du Namespace USER ID de l&#8217;hôte</h3><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --userns=host busybox</code></pre></div></div>
<aside class="notes"><div class="ulist"><ul><li><p>Si vous avez fait un remap MAIS que vous avez besoin de mapper sur les uid des utilisateurs de l&#8217;host</p></li><li><p>"Lorsqu’un conteneur doit être démarré en partageant le namespace USER ID avec celui de l’hôte, et que le service Docker est configuré pour démarrer tous les conteneurs avec un namespace USER ID distinct de celui de l’hôte, il est possible d’utiliser l’option --userns=host au démarrage du conteneur. Dans ce cas, la menace de compromission de l’utilisateur root (UID=0) de l’hôte par le conteneur est à considérer."</p></li></ul></div></aside></div></section><section id="_révision"><h2>Révision</h2><div class="slide-content"><h3>Les capabilities Kernel</h3><div class="ulist"><ul><li><p>"Privilèges" que donne le noyau donne à des programmes</p></li></ul></div></div></section><section id="_révision_2"><h2>Révision</h2><div class="slide-content"><h3>Les capabilities offertes aux containers</h3><table class="tableblock frame-none grid-none capabilities-table" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p>CAP_AUDIT_WRITE</p></li><li><p>CAP_CHOWN</p></li><li><p>CAP_DAC_OVERRIDE</p></li><li><p>CAP_FOWNER</p></li><li><p>CAP_FSETID</p></li><li><p>CAP_KILL</p></li><li><p>CAP_NET_BIND_SERVICE</p></li></ul></div></div></td><td class="tableblock halign-left valign-top"><div><div class="ulist"><ul><li><p>CAP_NET_RAW</p></li><li><p>CAP_MKNOD</p></li><li><p>CAP_SETFCAP</p></li><li><p>CAP_SETPCAP</p></li><li><p>CAP_SETUID</p></li><li><p>CAP_SETGID</p></li><li><p>CAP_SYS_CHROOT</p></li></ul></div></div></td></tr></table></div></section><section id="_r8" class="background-hard"><h2>R8</h2><div class="slide-content"><h3>Interdire l&#8217;utilisation des capabilities</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:50%"><col style="width:50%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --cap-drop=ALL busybox</code></pre></div></div></div></td><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    cap_drop:
      - ALL</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Chaque conteneur doit être démarré sans aucune capability avec l’option --cap-drop=ALL"</p></li><li><p>Sur des outils que vous ne maitrisez pas, c&#8217;est risqué (genre gitlab)</p></li></ul></div></aside></div></section><section id="_r8_2" class="background-hard"><h2>R8-</h2><div class="slide-content"><h3>Limiter l&#8217;utilisation des capabilities</h3><table class="tableblock frame-none grid-none" style="width:100%"><colgroup><col style="width:100%"></colgroup><tbody><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-bash hljs" data-noescape="true" data-lang="bash">docker run --cap-drop=ALL --cap-add=CHOWN busybox</code></pre></div></div></div></td></tr><tr><td class="tableblock halign-left valign-top"><div><div class="listingblock"><div class="content"><pre class="highlightjs highlight"><code class="language-yaml hljs" data-noescape="true" data-lang="yaml">version: "2.7"
services:
  busybox:
    image: busybox
    cap_drop:
      - ALL
    cap_add:
      - CHOWN</code></pre></div></div></div></td></tr></table>
<aside class="notes"><div class="ulist"><ul><li><p>"Un conteneur peut être démarré avec les capabilities strictement nécessaires, non sensibles, avec les options --cap-drop=ALL et --cap-add={”capability A”}."</p></li><li><p>Next slide</p></li></ul></div></aside></div></section><section id="_die_and_retry"><h2>Die and retry</h2><div class="slide-content"><aside class="notes"><div class="ulist"><ul><li><p>Et là, c&#8217;est Die and retry</p></li><li><p>Il n&#8217;y a pas, aujourd&#8217;hui, de recette magique pour trouver les bonnes capabilities. Il faut tester si le service fonctionne et rajouter des capabilities jusqu&#8217;à ce que ce soit ok.</p></li></ul></div></aside></div></section><section id="_objectif"><h2>Objectif</h2><div class="slide-content"><div class="ulist"><ul><li><p>Restreindre au maximum les interactions que les containers peuvent avoir avec le système</p></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>On limite les actions que les containers peuvent faire</p></li></ul></div></aside></div></section></section>
<section><section id="_on_a_fini"><h2>On a fini</h2><div class="slide-content"><div class="paragraph"><p><span class="image"><img src="../../src/images/finish.png" alt="finish"></span></p></div><aside class="notes"><div class="ulist"><ul><li><p>On a fini avec les règles : ENFIN</p></li></ul></div></aside></div></section><section id="_du_coup_cest_sécurisé_maintenant"><h2>Du coup, c&#8217;est sécurisé maintenant ?</h2><div class="slide-content"><aside class="notes"></aside></div></section><section id="_non"><h2>NON !</h2><div class="slide-content"><aside class="notes"></aside></div></section><section id="_ce_quon_a_fait"><h2>Ce qu&#8217;on a fait :</h2><div class="slide-content"><div class="ulist"><ul><li><p>Limiter l&#8217;influence que les containers peuvent avoir :</p><div class="ulist"><ul><li><p>Entre eux</p></li><li><p>Avec l&#8217;host</p></li></ul></div></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Via les moyens suivants :</p></div>
<div class="ulist"><ul><li><p>Revue de la configuration par défaut du deamon</p></li><li><p>Limitation de la consommation des ressources</p></li><li><p>Isolation et indépendance maximum des containers via des paramètres de run</p></li><li><p>Reduction aux maximums des actions (commandes systèmes) que peut faire un container</p></li></ul></div></aside></div></section><section id="_et_donc"><h2>Et donc ?</h2><div class="slide-content"><div class="paragraph"><p>Il faut sécuriser tout le reste</p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Le build</p></li><li><p>L&#8217;application</p></li><li><p>Le réseau</p></li><li><p>L&#8217;infra</p></li></ul></div></aside></div></section></section>
<section><section id="_merci"><h2>Merci</h2></section><section class="sponso"></section></section></div></div><script src="../node_modules/reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'slide',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 960,
  height: 700,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: '../node_modules/reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: '../node_modules/reveal.js/plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(960, 700)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(960, 700)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(960, 700)
});</script><link rel="stylesheet" href="../node_modules/reveal.js/lib/css/monokai.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>

<script>

/* highlightjs-line-numbers.js 2.6.0 | (C) 2018 Yauheni Pakala | MIT License | github.com/wcoder/highlightjs-line-numbers.js */
/* Edited by Hakim for reveal.js; removed async timeout */
!function(n,e){"use strict";function t(){var n=e.createElement("style");n.type="text/css",n.innerHTML=g(".{0}{border-collapse:collapse}.{0} td{padding:0}.{1}:before{content:attr({2})}",[v,L,b]),e.getElementsByTagName("head")[0].appendChild(n)}function r(t){"interactive"===e.readyState||"complete"===e.readyState?i(t):n.addEventListener("DOMContentLoaded",function(){i(t)})}function i(t){try{var r=e.querySelectorAll("code.hljs,code.nohighlight");for(var i in r)r.hasOwnProperty(i)&&l(r[i],t)}catch(o){n.console.error("LineNumbers error: ",o)}}function l(n,e){"object"==typeof n&&f(function(){n.innerHTML=s(n,e)})}function o(n,e){if("string"==typeof n){var t=document.createElement("code");return t.innerHTML=n,s(t,e)}}function s(n,e){e=e||{singleLine:!1};var t=e.singleLine?0:1;return c(n),a(n.innerHTML,t)}function a(n,e){var t=u(n);if(""===t[t.length-1].trim()&&t.pop(),t.length>e){for(var r="",i=0,l=t.length;i<l;i++)r+=g('<tr><td class="{0}"><div class="{1} {2}" {3}="{5}"></div></td><td class="{4}"><div class="{1}">{6}</div></td></tr>',[j,m,L,b,p,i+1,t[i].length>0?t[i]:" "]);return g('<table class="{0}">{1}</table>',[v,r])}return n}function c(n){var e=n.childNodes;for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];h(r.textContent)>0&&(r.childNodes.length>0?c(r):d(r.parentNode))}}function d(n){var e=n.className;if(/hljs-/.test(e)){for(var t=u(n.innerHTML),r=0,i="";r<t.length;r++){var l=t[r].length>0?t[r]:" ";i+=g('<span class="{0}">{1}</span>\n',[e,l])}n.innerHTML=i.trim()}}function u(n){return 0===n.length?[]:n.split(y)}function h(n){return(n.trim().match(y)||[]).length}function f(e){e()}function g(n,e){return n.replace(/{(\d+)}/g,function(n,t){return e[t]?e[t]:n})}var v="hljs-ln",m="hljs-ln-line",p="hljs-ln-code",j="hljs-ln-numbers",L="hljs-ln-n",b="data-line-number",y=/\r\n|\r|\n/g;n.hljs?(n.hljs.initLineNumbersOnLoad=r,n.hljs.lineNumbersBlock=l,n.hljs.lineNumbersValue=o,t()):n.console.error("highlight.js not detected!")}(window,document);

/**
 * This reveal.js plugin is wrapper around the highlight.js
 * syntax highlighting library.
 */
(function( root, factory ) {
  if (typeof define === 'function' && define.amd) {
    root.RevealHighlight = factory();
  } else if( typeof exports === 'object' ) {
    module.exports = factory();
  } else {
    // Browser globals (root is window)
    root.RevealHighlight = factory();
  }
}( this, function() {

  // Function to perform a better "data-trim" on code snippets
  // Will slice an indentation amount on each line of the snippet (amount based on the line having the lowest indentation length)
  function betterTrim(snippetEl) {
    // Helper functions
    function trimLeft(val) {
      // Adapted from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/Trim#Polyfill
      return val.replace(/^[\s\uFEFF\xA0]+/g, '');
    }
    function trimLineBreaks(input) {
      var lines = input.split('\n');

      // Trim line-breaks from the beginning
      for (var i = 0; i < lines.length; i++) {
        if (lines[i].trim() === '') {
          lines.splice(i--, 1);
        } else break;
      }

      // Trim line-breaks from the end
      for (var i = lines.length-1; i >= 0; i--) {
        if (lines[i].trim() === '') {
          lines.splice(i, 1);
        } else break;
      }

      return lines.join('\n');
    }

    // Main function for betterTrim()
    return (function(snippetEl) {
      var content = trimLineBreaks(snippetEl.innerHTML);
      var lines = content.split('\n');
      // Calculate the minimum amount to remove on each line start of the snippet (can be 0)
      var pad = lines.reduce(function(acc, line) {
        if (line.length > 0 && trimLeft(line).length > 0 && acc > line.length - trimLeft(line).length) {
          return line.length - trimLeft(line).length;
        }
        return acc;
      }, Number.POSITIVE_INFINITY);
      // Slice each line with this amount
      return lines.map(function(line, index) {
        return line.slice(pad);
      })
        .join('\n');
    })(snippetEl);
  }

  var RevealHighlight = {

    HIGHLIGHT_STEP_DELIMITER: '|',
    HIGHLIGHT_LINE_DELIMITER: ',',
    HIGHLIGHT_LINE_RANGE_DELIMITER: '-',

    init: function() {

      // Read the plugin config options and provide fallbacks
      var config = Reveal.getConfig().highlight || {};
      config.highlightOnLoad = typeof config.highlightOnLoad === 'boolean' ? config.highlightOnLoad : true;
      config.escapeHTML = typeof config.escapeHTML === 'boolean' ? config.escapeHTML : true;

      [].slice.call( document.querySelectorAll( '.reveal pre code' ) ).forEach( function( block ) {

        // Trim whitespace if the "data-trim" attribute is present
        if( block.hasAttribute( 'data-trim' ) && typeof block.innerHTML.trim === 'function' ) {
          block.innerHTML = betterTrim( block );
        }

        // Escape HTML tags unless the "data-noescape" attrbute is present
        if( config.escapeHTML && !block.hasAttribute( 'data-noescape' )) {
          block.innerHTML = block.innerHTML.replace( /</g,"&lt;").replace(/>/g, '&gt;' );
        }

        // Re-highlight when focus is lost (for contenteditable code)
        block.addEventListener( 'focusout', function( event ) {
          hljs.highlightBlock( event.currentTarget );
        }, false );

        if( config.highlightOnLoad ) {
          RevealHighlight.highlightBlock( block );
        }
      } );

    },

    /**
     * Highlights a code block. If the <code> node has the
     * 'data-line-numbers' attribute we also generate slide
     * numbers.
     *
     * If the block contains multiple line highlight steps,
     * we clone the block and create a fragment for each step.
     */
    highlightBlock: function( block ) {

      hljs.highlightBlock( block );

      // Don't generate line numbers for empty code blocks
      if( block.innerHTML.trim().length === 0 ) return;

      if( block.hasAttribute( 'data-line-numbers' ) ) {
        hljs.lineNumbersBlock( block, { singleLine: true } );

        // If there is at least one highlight step, generate
        // fragments
        var highlightSteps = RevealHighlight.deserializeHighlightSteps( block.getAttribute( 'data-line-numbers' ) );
        if( highlightSteps.length > 1 ) {

          // If the original code block has a fragment-index,
          // each clone should follow in an incremental sequence
          var fragmentIndex = parseInt( block.getAttribute( 'data-fragment-index' ), 10 );
          if( typeof fragmentIndex !== 'number' || isNaN( fragmentIndex ) ) {
            fragmentIndex = null;
          }

          // Generate fragments for all steps except the original block
          highlightSteps.slice(1).forEach( function( highlight ) {

            var fragmentBlock = block.cloneNode( true );
            fragmentBlock.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlight ] ) );
            fragmentBlock.classList.add( 'fragment' );
            block.parentNode.appendChild( fragmentBlock );
            RevealHighlight.highlightLines( fragmentBlock );

            if( typeof fragmentIndex === 'number' ) {
              fragmentBlock.setAttribute( 'data-fragment-index', fragmentIndex );
              fragmentIndex += 1;
            }
            else {
              fragmentBlock.removeAttribute( 'data-fragment-index' );
            }

          } );

          block.removeAttribute( 'data-fragment-index' )
          block.setAttribute( 'data-line-numbers', RevealHighlight.serializeHighlightSteps( [ highlightSteps[0] ] ) );

        }

        RevealHighlight.highlightLines( block );

      }

    },

    /**
     * Visually emphasize specific lines within a code block.
     * This only works on blocks with line numbering turned on.
     *
     * @param {HTMLElement} block a <code> block
     * @param {String} [linesToHighlight] The lines that should be
     * highlighted in this format:
     * "1" 		= highlights line 1
     * "2,5"	= highlights lines 2 & 5
     * "2,5-7"	= highlights lines 2, 5, 6 & 7
     */
    highlightLines: function( block, linesToHighlight ) {

      var highlightSteps = RevealHighlight.deserializeHighlightSteps( linesToHighlight || block.getAttribute( 'data-line-numbers' ) );

      if( highlightSteps.length ) {

        highlightSteps[0].forEach( function( highlight ) {

          var elementsToHighlight = [];

          // Highlight a range
          if( typeof highlight.end === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child(n+'+highlight.start+'):nth-child(-n+'+highlight.end+')' ) );
          }
          // Highlight a single line
          else if( typeof highlight.start === 'number' ) {
            elementsToHighlight = [].slice.call( block.querySelectorAll( 'table tr:nth-child('+highlight.start+')' ) );
          }

          if( elementsToHighlight.length ) {
            elementsToHighlight.forEach( function( lineElement ) {
              lineElement.classList.add( 'highlight-line' );
            } );

            block.classList.add( 'has-highlights' );
          }

        } );

      }

    },

    /**
     * Parses and formats a user-defined string of line
     * numbers to highlight.
     *
     * @example
     * RevealHighlight.deserializeHighlightSteps( '1,2|3,5-10' )
     * // [
     * //   [ { start: 1 }, { start: 2 } ],
     * //   [ { start: 3 }, { start: 5, end: 10 } ]
     * // ]
     */
    deserializeHighlightSteps: function( highlightSteps ) {

      // Remove whitespace
      highlightSteps = highlightSteps.replace( /\s/g, '' );

      // Divide up our line number groups
      highlightSteps = highlightSteps.split( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

      return highlightSteps.map( function( highlights ) {

        return highlights.split( RevealHighlight.HIGHLIGHT_LINE_DELIMITER ).map( function( highlight ) {

          // Parse valid line numbers
          if( /^[\d-]+$/.test( highlight ) ) {

            highlight = highlight.split( RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER );

            var lineStart = parseInt( highlight[0], 10 ),
              lineEnd = parseInt( highlight[1], 10 );

            if( isNaN( lineEnd ) ) {
              return {
                start: lineStart
              };
            }
            else {
              return {
                start: lineStart,
                end: lineEnd
              };
            }

          }
          // If no line numbers are provided, no code will be highlighted
          else {

            return {};

          }

        } );

      } );

    },

    /**
     * Serializes parsed line number data into a string so
     * that we can store it in the DOM.
     */
    serializeHighlightSteps: function( highlightSteps ) {

      return highlightSteps.map( function( highlights ) {

        return highlights.map( function( highlight ) {

          // Line range
          if( typeof highlight.end === 'number' ) {
            return highlight.start + RevealHighlight.HIGHLIGHT_LINE_RANGE_DELIMITER + highlight.end;
          }
          // Single line
          else if( typeof highlight.start === 'number' ) {
            return highlight.start;
          }
          // All lines
          else {
            return '';
          }

        } ).join( RevealHighlight.HIGHLIGHT_LINE_DELIMITER );

      } ).join( RevealHighlight.HIGHLIGHT_STEP_DELIMITER );

    }

  }

  Reveal.registerPlugin( 'highlight', RevealHighlight );

  return RevealHighlight;

}));
        
hljs.initHighlightingOnLoad();
</script></body></html>